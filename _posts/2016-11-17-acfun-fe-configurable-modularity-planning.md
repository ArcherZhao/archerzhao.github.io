### 从吐槽说起

去年年底入职A站之后很长一段时间我都在撸CMS，从接手维护angular写的老项目，到后来自己用react从新搭起一套新东西。那时候就我一个人闷头搞（嗯，我们组里就我一个前端），想了很多，怎样组织目录结构，以后要是有别人参与进来能不能快速看懂，换种写法会不会更好，然后就是不断重构自己的代码去尝试更优解。一直到大概今年二季度，部门调整，然后有幸陆续把A站几个前端项目参与了个遍。感受嘛……哔了狗了。曾经自诩一级造粪师，如今却被强行喂屎，正所谓善恶终有报，天道好轮回:) 不过我今天并不是想来吐槽的，该吐的已经和同事们一起吐过了，只能说之前武汉那帮老猴子们太TM不专业了，我们这些新猴子被坑的很惨啊喂。

虽然被恶心到了，不过收获之一就是对烂代码有了更清晰的认识。其实吧烂代码和烂代码还不太一样，有的是因为逻辑奇怪，代码前后矛盾：比如创建一个对象赋值给一个变量，到后面又把别的什么东西赋给同一个变量，这我就很纠结了，你这样是不是有什么深意啊。另一种烂代码就纯粹是坏习惯导致的：比如变量名瞎JB起，随手就是o, i这种单字符变量名，我怎么知道这是个啥，算了，我全局搜索一下吧……fuck！你单字符我搜个毛啊，全屏都亮了好吗。

一不小心还是吐槽了，忍不了啊……orz

### 干货

还是说点有意思的吧。故事要从去年年底说起，当时我们组讨论了一种通过后台CMS配置来控制前端模块展示的思路。我还大致记得当时我提出的方案：

几个要点：

  1. 后台配置只用来控制页面布局，不操纵具体细节。例如：边框，动效等
  2. 布局单位分为区块和模块两类，区块用于划分区域，模块用于定义区域内容
  3. 整个页面拥有唯一的root区块，管理者添加的所有区块都必须从属于root区块
  4. 区块可以左右或者上下分栏，可以套模块，也可以继续嵌套更小的区块，模块不能嵌套模块或区块

讨论了几次之后我就继续撸我的用户管理系统去了，对之后他们定下的方案以及实现效果并没有继续关注。直到几个月后人员调整前端合并，我才参与到在这套思路下实现的新主站项目。

首先要感谢早已离职的强哥，顶着巨大的压力与困难，几乎凭借一己之力完成了前端新主站项目的雏形，但我必须说，这个项目基本就是从这个雏形就开始走偏了。

以首页为例，当用户浏览A站首页时，请求发送给node页面服务，根据访问地址，再请求对应的服务接口获取该页面的区块模块数据，返回数据如下：

    {
      id: 1,                // 页面标识id
      components: [{
        typeId: 18,         // 区块类型id
        id: 164,            // 区块数据id
        name: "区块名称",
        ...
      },{
        typeId: 19,
        id: 165,
        name: "区块名称",
        ...
      },
      ...
      ]
    }

这是我随手写的假数据，字段名和值都是编的，但大概就是这样一个格式，`components` 字段的数组里包含了页面所有的几个区块，区块数据对象里有两个关键字段，一个是用来代表区块类型的 `typeId`，页面服务根据这个id调用对应的区块模版文件，另一个是 `id` ，node会根据这个字段再次发起请求获取该区块下的模块数据，返回结果如下：

    {
      id: 164,
      typeId: 18,
      name: "区块名称",
      title: "区块展示标题",
      moduleContent: [{         // 模块数组
        id: 23,
        moduleId: 170,          // 模块类型id
        data: [{                // 模块数据
          url: "/v/ac201714",
          title: "数据标题",
          ...
        }, {
          url: "/v/ac3234534",
          title: "随便了，反正就是些数据"
          ...
        },
        ...
        ]
      },{
        id: 24,
        moduleId: 180,
        data: [...]
      }
        ...
      ]
    }

也是随手编的，通常这个对象包含了渲染该区块所需要的所有数据，除了某些特殊模块。这样，数据有了，模版也有了，页面就可以渲染了。

通过后台调整页面引用的区块类型和数量，或者改变区块里的模块，就可以改变页面的布局和内容了。

到这里，我想有人已经发现问题了。那么接下来我来逐一说明。

1. 和我上面提到的方案相比，这套实现里不存在区块嵌套的问题，区块下面只能有模块，这样做好处是实现更简单，但局限性也更大，由于不能嵌套，区块很难完全承担起布局的任务，需要前端写死部分布局规则。

2. 区块和模块深度绑定，引用了某个区块，就只能引用这个区块所有的模块。这个其实还是因为上面那一条导致的，由于区块的定位不清，在模版层面已经把区块能用哪几个模块模版写死了，只能少不能多。如果接口数据里该区块没有某个我区块里有的模块，那我可以不引入该模块的模版，但如果你数据里有个我区块模版里没有的模块，那对不起，我不认识。

3. 一个区块不能重复引用同一个模块。这个问题当时是和产品沟通过的，确认可以才这么做的，但并不是不能解决的，归根到底是因为controller和区块模版对数据处理的太糙了，对数据多处理一层就行了，比较好解决。

4. 由于页面区块模块是由后台配置的，导致页面模板非常不直观，看代码完全无法直接和页面对应上，这个无解。大概只能通过demo的方式来改善了。

5. 最大的问题，css与js并不能配合模块模版自动引入。这套模块化方案只做了html的可配置化。也就是说如果接口数据改了，我要引用另一个模块，那么页面的html部分可以自动变成那个模块的，而页面引用的css和js却没有任何变化……这就尴尬了呀……

大概就先写这些，因为我到站了～Y(^_^)Y 等回北京的路上继续写下篇——一个个解决。

当然，我是可以理解强哥的，当时确实时间太紧了，古人云：我见XX多弱鸡，料XX见我应如是。在说别人菜的同时多想想自己是不是也有问题，菜鸡互啄确实有趣，但，每一个青铜都有一颗王者的心。:-)
